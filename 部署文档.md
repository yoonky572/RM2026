# RM2026 项目部署指南

本文档提供在仅有 ROS 和 PCL 1.10 的系统上部署本项目的详细步骤。

## 目录

- [快速开始](#快速开始)
- [系统要求](#系统要求)
- [依赖安装](#依赖安装)
- [编译 PCL 1.11.1](#编译-pcl-1111)
- [项目配置](#项目配置)
- [编译项目](#编译项目)
- [常见问题](#常见问题)

---

## 快速开始

如果您熟悉 ROS 和 CMake，可以按照以下步骤快速部署：

1. **安装 ROS Noetic 和系统依赖**（约 10-20 分钟）
   ```bash
   sudo apt update
   sudo apt install -y ros-noetic-desktop-full
   sudo apt install -y libpcl-dev libeigen3-dev libflann-dev libomp-dev libopencv-dev nlohmann-json3-dev
   # 更多依赖见"依赖安装"章节
   ```

2. **编译 PCL 1.11.1**（约 30-60 分钟）
   ```bash
   cd ~
   git clone --branch pcl-1.11.1 https://github.com/PointCloudLibrary/pcl.git pcl-1.11.1
   cd pcl-1.11.1 && mkdir build && cd build
   cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_apps=OFF -DBUILD_examples=OFF
   make -j$(nproc)
   ```

3. **配置项目路径**（如果用户名不是 `ybw`）
   ```bash
   cd ~/RM2026
   # 使用配置脚本或手动修改 CMakeLists.txt 中的路径
   # 见"项目配置"章节
   ```

4. **编译项目**
   ```bash
   cd ~/RM2026
   catkin_make
   source devel/setup.bash
   ```

**注意**：首次部署建议完整阅读本文档，确保所有步骤正确执行。

---

## 项目包依赖关系说明

### PCL 版本使用情况

本项目包含多个 ROS 包，它们对 PCL 版本的要求不同：

#### 需要使用 PCL 1.11 的包
- **`segmentation`** - 使用 `small_gicp` 库，需要 PCL 1.11+
- **`relocalization`** - 使用 `small_gicp` 库，需要 PCL 1.11+

这些包已配置为使用本地编译的 PCL 1.11.1，路径为 `~/pcl-1.11.1/build`。

#### 使用系统 PCL 1.10 的包
- **`navigation`** - 标准导航功能
- **`tracking`** - 目标跟踪
- **`sentry_simulation`** - 仿真环境
- **`livox_ros_driver2`** - Livox 激光雷达驱动
- **`livox_laser_simulation`** - Livox 仿真
- **`Point-LIO-master`** - 激光里程计
- **`goal_distribute`** - 目标分配
- **`recovery`** - 恢复行为
- **`costmap_prohibition_layer`** - 代价地图禁止层

这些包使用系统默认的 PCL 1.10，无需额外配置。

### 包依赖关系

```
segmentation  ──┐
                ├──> 需要 PCL 1.11
relocalization ─┘

navigation ──────┐
tracking ────────├──> 使用 PCL 1.10
sentry_simulation┤
其他包 ───────────┘
```

这种混合使用 PCL 版本的设计允许项目同时支持需要新版本 PCL 的功能（如 `small_gicp`）和依赖系统稳定版本的功能。

---

## 系统要求

### 操作系统
- **Ubuntu 20.04** (推荐)
- 其他 Ubuntu 版本可能需要调整依赖包版本

### 必需软件
- **ROS Noetic** (桌面完整版推荐)
- **PCL 1.10** (系统默认版本)
- **CMake** 3.0.2 或更高版本
- **GCC/G++** 支持 C++17 标准

---

## 依赖安装

### 1. 安装 ROS Noetic

如果尚未安装 ROS Noetic，请按照以下步骤安装：

```bash
# 设置软件源
sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
sudo apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654

# 更新软件包列表
sudo apt update

# 安装 ROS Noetic 桌面完整版
sudo apt install ros-noetic-desktop-full

# 初始化 rosdep
sudo rosdep init
rosdep update

# 设置环境变量
echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

### 2. 安装系统依赖库

```bash
# 更新软件包列表
sudo apt update

# 安装 PCL 1.10 及相关依赖
sudo apt install -y \
    libpcl-dev \
    pcl-tools

# 安装编译工具和基础库
sudo apt install -y \
    build-essential \
    cmake \
    git \
    wget \
    curl \
    libboost-all-dev \
    libeigen3-dev \
    libflann-dev \
    libvtk7-dev \
    libqhull-dev \
    libopenni-dev \
    libopenni2-dev \
    libusb-1.0-0-dev \
    libgtest-dev \
    libcgal-dev

# 安装 OpenMP（用于并行计算）
sudo apt install -y libomp-dev

# 安装 OpenCV（用于图像处理）
sudo apt install -y \
    libopencv-dev \
    python3-opencv

# 安装 Gazebo（用于仿真）
sudo apt install -y \
    ros-noetic-gazebo-ros-pkgs \
    ros-noetic-gazebo-ros-control

# 安装 ROS 相关包
sudo apt install -y \
    ros-noetic-costmap-2d \
    ros-noetic-nav-core \
    ros-noetic-pcl-ros \
    ros-noetic-pcl-conversions \
    ros-noetic-tf2-ros \
    ros-noetic-tf2-eigen \
    ros-noetic-message-filters \
    ros-noetic-serial \
    ros-noetic-eigen-conversions

# 安装 JSON 库（用于 goal_distribute 包）
sudo apt install -y nlohmann-json3-dev

# 安装 lz4（PCL I/O 依赖）
sudo apt install -y liblz4-dev
```

### 3. 创建工作空间目录

```bash
# 创建工作空间（如果尚未创建）
mkdir -p ~/RM2026/src
cd ~/RM2026
```

---

## 编译 PCL 1.11.1

**重要说明**：`segmentation` 和 `relocalization` 包需要 PCL 1.11 来支持 `small_gicp` 库。其他包使用系统 PCL 1.10。

### 1. 下载 PCL 1.11.1 源码

```bash
cd ~
# 如果无法访问 GitHub，可以从其他源下载或使用已下载的源码
# 方法1：从 GitHub 下载（需要网络）
git clone --branch pcl-1.11.1 https://github.com/PointCloudLibrary/pcl.git pcl-1.11.1

# 方法2：如果已有源码，直接解压到 ~/pcl-1.11.1 目录
# 或使用 wget 下载源码压缩包
```

### 2. 配置和编译 PCL 1.11.1

```bash
cd ~/pcl-1.11.1
mkdir build
cd build

# 配置 CMake（不安装到系统，只在本地构建）
cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=~/pcl-1.11.1/install \
    -DBUILD_CUDA=OFF \
    -DBUILD_GPU=OFF \
    -DBUILD_apps=OFF \
    -DBUILD_examples=OFF \
    -DBUILD_common=ON \
    -DBUILD_kdtree=ON \
    -DBUILD_io=ON \
    -DBUILD_filters=ON \
    -DBUILD_features=ON \
    -DBUILD_search=ON \
    -DBUILD_sample_consensus=ON \
    -DBUILD_octree=ON \
    -DBUILD_registration=ON \
    -DWITH_CUDA=OFF \
    -DWITH_OPENGL=ON \
    -DWITH_QT=OFF

# 编译（根据 CPU 核心数调整 -j 参数）
make -j$(nproc)

# 注意：我们不需要安装 PCL 1.11.1 到系统，只需要编译产物
```

### 3. 验证 PCL 1.11.1 编译结果

```bash
# 检查 PCLConfig.cmake 是否存在
ls -la ~/pcl-1.11.1/build/PCLConfig.cmake

# 应该显示文件存在
```

---

## 项目配置

### 1. 克隆或复制项目代码

```bash
cd ~/RM2026/src
# 根据实际情况克隆或复制代码
# git clone <your-repository-url> .
# 或直接复制代码到此目录
```

### 2. 配置 PCL 1.11.1 路径

**重要**：项目中的 `segmentation` 和 `relocalization` 包需要配置 PCL 1.11.1 的路径。默认配置使用的是 `/home/ybw/pcl-1.11.1/build`。

#### 方法 1：使用默认路径（推荐）

如果您将 PCL 1.11.1 编译到 `~/pcl-1.11.1` 目录（即 `/home/<用户名>/pcl-1.11.1`），且用户名是 `ybw`，则无需修改。

#### 方法 2：使用环境变量配置（推荐用于多用户环境）

您可以创建一个配置脚本来批量替换路径：

```bash
# 创建配置脚本
cat > ~/RM2026/configure_pcl_path.sh << 'EOF'
#!/bin/bash

# 设置您的 PCL 1.11.1 构建目录路径
PCL_111_BUILD_DIR="$HOME/pcl-1.11.1/build"
PCL_111_SOURCE_DIR="$HOME/pcl-1.11.1"

# 如果路径不同，请修改上面的变量

echo "配置 PCL 1.11.1 路径为: $PCL_111_BUILD_DIR"

# 替换 segmentation/CMakeLists.txt 中的路径
if [ -f "src/segmentation/CMakeLists.txt" ]; then
    sed -i "s|/home/ybw/pcl-1.11.1/build|${PCL_111_BUILD_DIR}|g" src/segmentation/CMakeLists.txt
    sed -i "s|/home/ybw/pcl-1.11.1|${PCL_111_SOURCE_DIR}|g" src/segmentation/CMakeLists.txt
    echo "✓ 已更新 src/segmentation/CMakeLists.txt"
fi

# 替换 relocalization/CMakeLists.txt 中的路径
if [ -f "src/relocalization/CMakeLists.txt" ]; then
    sed -i "s|/home/ybw/pcl-1.11.1/build|${PCL_111_BUILD_DIR}|g" src/relocalization/CMakeLists.txt
    sed -i "s|/home/ybw/pcl-1.11.1|${PCL_111_SOURCE_DIR}|g" src/relocalization/CMakeLists.txt
    echo "✓ 已更新 src/relocalization/CMakeLists.txt"
fi

# 替换 sentry_simulation/CMakeLists.txt 中的路径（移除硬编码路径）
if [ -f "src/sentry_simulation/CMakeLists.txt" ]; then
    sed -i "s|/home/ybw/pcl-1.11.1/build|${PCL_111_BUILD_DIR}|g" src/sentry_simulation/CMakeLists.txt
    echo "✓ 已更新 src/sentry_simulation/CMakeLists.txt"
fi

echo "配置完成！"
EOF

chmod +x ~/RM2026/configure_pcl_path.sh

# 运行配置脚本
cd ~/RM2026
./configure_pcl_path.sh
```

#### 方法 3：手动修改文件

如果您的 PCL 1.11.1 路径与默认不同，需要手动修改以下文件：

**修改 `src/segmentation/CMakeLists.txt`**（约第 26-27 行和第 40 行附近）：
```cmake
# 将这些行：
list(INSERT CMAKE_PREFIX_PATH 0 "/home/ybw/pcl-1.11.1/build")
set(PCL_DIR "/home/ybw/pcl-1.11.1/build" CACHE PATH "PCL 1.11.1 build directory")
include_directories(/home/ybw/pcl-1.11.1/registration/include)

# 替换为您的路径，例如：
list(INSERT CMAKE_PREFIX_PATH 0 "/home/<您的用户名>/pcl-1.11.1/build")
set(PCL_DIR "/home/<您的用户名>/pcl-1.11.1/build" CACHE PATH "PCL 1.11.1 build directory")
include_directories(/home/<您的用户名>/pcl-1.11.1/registration/include)
```

**修改 `src/relocalization/CMakeLists.txt`**（约第 24-25 行和第 40 行附近）：
```cmake
# 同样替换路径
list(INSERT CMAKE_PREFIX_PATH 0 "/home/<您的用户名>/pcl-1.11.1/build")
set(PCL_DIR "/home/<您的用户名>/pcl-1.11.1/build" CACHE PATH "PCL 1.11.1 build directory")
include_directories(/home/<您的用户名>/pcl-1.11.1/registration/include)
```

**修改 `src/sentry_simulation/CMakeLists.txt`**（约第 25 行）：
```cmake
# 确保移除硬编码的 PCL 1.11.1 路径
list(REMOVE_ITEM CMAKE_PREFIX_PATH "/home/<您的用户名>/pcl-1.11.1/build")
```

#### 验证路径配置

配置完成后，可以验证路径是否正确：

```bash
cd ~/RM2026
# 检查 segmentation 包中的路径
grep -n "pcl-1.11.1" src/segmentation/CMakeLists.txt

# 检查 relocalization 包中的路径
grep -n "pcl-1.11.1" src/relocalization/CMakeLists.txt
```

### 3. 配置自定义 CMake 模块

项目包含自定义 CMake 模块用于查找 Eigen 和 FLANN（位于 `cmake_modules/` 目录）。这些模块已配置为自动使用，无需额外配置。

### 4. 配置其他路径（可选）

某些包可能需要额外的包含路径。如果遇到编译错误，检查以下文件中的路径：

- `src/sentry_simulation/CMakeLists.txt`：包含路径配置
- `src/Point-LIO-master/CMakeLists.txt`：包含路径配置

根据实际情况修改硬编码的路径。

---

## 编译项目

### 1. 初始化工作空间

```bash
cd ~/RM2026
catkin_make

# 如果遇到错误，可以先清理构建目录
# rm -rf build devel
```

### 2. 设置环境变量

```bash
# 将以下行添加到 ~/.bashrc
echo "source ~/RM2026/devel/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

### 3. 分步编译（推荐）

如果完整编译遇到问题，可以分步编译：

```bash
cd ~/RM2026

# 1. 先编译基础包（不依赖 PCL 1.11 的包）
catkin_make --only-pkg-with-deps navigation

# 2. 编译需要 PCL 1.11 的包
catkin_make --only-pkg-with-deps segmentation
catkin_make --only-pkg-with-deps relocalization

# 3. 编译其他包
catkin_make --only-pkg-with-deps tracking
catkin_make --only-pkg-with-deps sentry_simulation

# 4. 完整编译
catkin_make
```

### 4. 验证编译结果

```bash
# 检查生成的可执行文件
ls -la ~/RM2026/devel/lib/*/

# 应该看到各种可执行文件和库文件
```

---

## 常见问题

### 问题 1：找不到 PCL 1.11

**错误信息**：
```
Could not find a configuration file for package "PCL" that is compatible with requested version "1.11"
```

**解决方案**：
1. 确认 PCL 1.11.1 已正确编译，`PCLConfig.cmake` 文件存在于构建目录
2. 检查 `src/segmentation/CMakeLists.txt` 和 `src/relocalization/CMakeLists.txt` 中的路径是否正确
3. 清理构建缓存：`rm -rf ~/RM2026/build/segmentation ~/RM2026/build/relocalization`

### 问题 2：找不到 Eigen3

**错误信息**：
```
Could not find a package configuration file provided by "Eigen" (requested version 3.1)
```

**解决方案**：
```bash
sudo apt install libeigen3-dev
```

### 问题 3：找不到 FLANN

**错误信息**：
```
FLANN not found
```

**解决方案**：
```bash
sudo apt install libflann-dev
# 确认 pkg-config 可以找到 FLANN
pkg-config --modversion flann
```

### 问题 4：链接错误（undefined reference to pcl::...）

**错误信息**：
```
undefined reference to `pcl::PCLBase<...>::setInputCloud(...)`
```

**解决方案**：
这通常是因为链接了错误的 PCL 版本。确保：
1. 使用系统 PCL 1.10 的包（如 `sentry_simulation`, `tracking`）正确配置了 CMakeLists.txt
2. 确保没有在 `link_directories` 中包含 `/usr/local/lib`（如果那里有 PCL 1.11.1）
3. 清理构建目录并重新编译：`rm -rf build devel && catkin_make`

### 问题 5：找不到 ROS 包

**错误信息**：
```
Could not find a package configuration file provided by "costmap_2d"
```

**解决方案**：
```bash
sudo apt install ros-noetic-costmap-2d
# 或其他缺失的 ROS 包
rosdep install --from-paths src --ignore-src -r -y
```

### 问题 6：找不到 nlohmann/json

**错误信息**：
```
Could not find nlohmann_json
```

**解决方案**：
```bash
sudo apt install nlohmann-json3-dev
```

### 问题 7：编译 segmentation/relocalization 时找不到 PCL 头文件

**错误信息**：
```
fatal error: pcl/point_cloud.h: No such file or directory
```

**解决方案**：
1. 确认 PCL 1.11.1 已完整编译（包含所有需要的模块）
2. 检查 `src/segmentation/CMakeLists.txt` 和 `src/relocalization/CMakeLists.txt` 中的包含路径是否正确
3. 确认 PCL 1.11.1 源码目录结构完整

### 问题 8：small_gicp 静态断言失败

**错误信息**：
```
static_assert failed: 'PCL 1.11+ is required'
```

**解决方案**：
项目已通过定义 `SMALL_GICP_ALLOW_PCL_1_10` 宏来绕过此检查。如果仍遇到问题，检查：
1. `src/segmentation/include/small_gicp/pcl/pcl_point_traits.hpp`
2. `src/relocalization/include/small_gicp/pcl/pcl_point_traits.hpp`

确认 `#ifndef SMALL_GICP_ALLOW_PCL_1_10` 宏定义存在。

---

## 快速部署检查清单

- [ ] 已安装 ROS Noetic 桌面完整版
- [ ] 已安装所有系统依赖库
- [ ] 已编译 PCL 1.11.1 到 `~/pcl-1.11.1/build`
- [ ] 已配置项目中的 PCL 1.11.1 路径（如果不同于默认路径）
- [ ] 已克隆/复制项目代码到 `~/RM2026/src`
- [ ] 已执行 `catkin_make` 并成功编译
- [ ] 已将 `source ~/RM2026/devel/setup.bash` 添加到 `~/.bashrc`
- [ ] 已测试运行关键节点

---

## 支持

如果遇到本文档未涵盖的问题，请：

1. 检查编译日志中的详细错误信息
2. 确认所有依赖已正确安装
3. 检查 CMakeLists.txt 中的路径配置
4. 清理构建目录后重新编译

---

## 附录：完整依赖列表

### ROS 包
- `roscpp`, `rospy`, `std_msgs`, `sensor_msgs`, `geometry_msgs`, `nav_msgs`
- `tf`, `tf2_ros`, `pcl_ros`, `pcl_conversions`
- `costmap_2d`, `nav_core`, `gazebo_ros`, `livox_ros_driver2`
- `message_filters`, `serial`, `eigen_conversions`

### 系统库
- PCL 1.10（系统默认）
- PCL 1.11.1（本地编译，用于特定包）
- Eigen3
- FLANN
- Boost
- OpenCV
- OpenMP
- VTK7
- CGAL
- lz4

### 开发工具
- CMake 3.0.2+
- GCC/G++（支持 C++17）
- Git
- pkg-config

---

**最后更新**：2025年
